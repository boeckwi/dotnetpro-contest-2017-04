<html>
    <head>
		<script src="libraries/p5.min.js"></script>
        <script type="text/javascript">

            
            
            
function setupGlobal() {
   setFont1 = function () {
       fill(color('#7DB0FF'));
       textSize(36);
       textFont("Courier New");
       textStyle(BOLD);
       strokeWeight(0);    
        textAlign(LEFT);
   };
    
    setFont2 = function () {
        fill(color('#DDDD3F'));
        textSize(24);
        textFont("Courier New");
        textStyle(BOLD);
        strokeWeight(0);
        textAlign(LEFT);
    }
}




function Highscores() {
    this.ranks = [ 
        { name: "W*B", score: 1000 },
        { name: "VHW", score: 800 },
        { name: "BUK", score: 600 },
        { name: "LUW", score: 400 },
        { name: "DOH", score: 200 }
    ];
    
    this.draw = function () {
        setFont2();
        
        textAlign(CENTER);
        text("HIGHSCORES", width/2, 30);
        text("<ENTER>", width/2, height-10);
        
        for(var i=0; i < this.ranks.length; i++) {
            var r = this.ranks[i];
            var y = 80 + i * 30;
            
            
            textAlign(RIGHT);
            text(r.score.toLocaleString(), width/2 - 10, y);

            textAlign(LEFT);
            text(r.name, width/2 + 30, y);
        }
    }
    
    this.keyPressed = function () {
        if(keyCode === 13) {
            this.nextScene = new Game();
        }
    }
    
    this.canBeInserted = function(score) {
        return score > this.ranks[this.ranks.length - 1].score;
    }
    
    this.insertScore = function (name, score) {
        this.ranks.push({name: name, score: score});
        
        this.ranks = this.ranks.sort(function(a, b) {
            if(a.score < b.score) return 1;
            if(a.score > b.score) return -1;
            return 0;
        });
        this.ranks.pop();
    }
}
            
            
            
            
            
function Score() {
    'use strict';
    
    this.points = 0;
    this.nextScoreOffset = 0;
    
    this.charHit = function () {
        var score = 100 + this.nextScoreOffset;
        if(score > 0) {
            this.points += score;
        }
        this.nextScoreOffset = 0;
    }
    
    this.stageCleared = function () {
        
    }
    
    this.charMissed = function() {
        this.nextScoreOffset -= 20;
    }
}
            
            
            
function Gameover(score) {
    'use strict';
    
    this.name = "___";
    this.nameIndex = 0;
    
    this.score = score || new Score();

    this.setup = function () {
        if(highscores.canBeInserted(this.score.points)) {
            this.setupWithHighscore();
        } else {
            this.setupWithoutHighscore();
        }
    }
    
    this.setupWithHighscore = function () {
        this.keyPressed = this.keyPressedWithHighscore;
        this.getMessage = function () { 
            return "ENTER YOUR INITIALS: " + this.name 
        }
    }

    this.setupWithoutHighscore = function () {
        this.keyPressed = this.keyPressedWithoutHighscore;
        this.getMessage = function () {
            return "<ENTER>";
        };
    }
    
    this.draw = function () {
        var offset_y = 30;
        
        var line = function () {
            offset_y += 30;
            return offset_y;
        };
        
        setFont2();
        textAlign(CENTER);
        
        text("YOUR SCORE: " + this.score.points.toLocaleString(), width/2, height*1/3);
        
        text(this.getMessage(), width/2, height*2/3);
    }
    
    this.keyPressedWithHighscore = function () {
        var keyChar = char(keyCode).toUpperCase();
        if (/[A-Z]/.test(keyChar)) {
            this.allowedLetterPressed(keyChar);
        }
    }
    
    this.keyPressedWithoutHighscore = function () {
        if (keyCode === 13) {
            this.exit();
        }
    }
    
    this.exit = function () {
        this.nextScene = highscores;
    }
    
    this.allowedLetterPressed = function (letter) {
        this.name = this.replaceAt(this.name, this.nameIndex, letter);
        if(this.name[this.nameIndex+1]) {
            this.nameIndex ++;
        } else {
            highscores.insertScore(this.name, this.score.points);
            this.exit();
        }
    }
    
    this.replaceAt = function(text, index, character) {
        return text.substr(0, index) + character + text.substr(index + character.length);
    }
}

            
            
            
function Game() {
    'use strict';

    this.score = new Score();
    this.textArray = ["asdf", "Lorem ipsum dolor sit amet.", "asdf", "asdf", "asdf"];
    this.lives = 3;
    this.speed = 1;
    this.stageIndex = 0;
    this.specialAnimation = 0;
    
    
    this.setup = function () {
        this.stageSpecials = [
          this.noSpecial,
          this.sinusSpecial,
          this.cosinusSpecial,
          this.crazySpecial
        ];
        this.stageCount = this.textArray.length;
        this.beforeStage();
        this.tick = this.tick_waitForFirstKey;
    };

    this.beforeStage = function () {
        this.text_x = width / 2;
        this.text_y = height / 2;
        this.text = this.textArray.shift();
        this.removedLettersInThisStage = 0;
        this.totalLettersInThisStage = this.text.length;
        this.tick = this.tick_scroll;
        this.blinkAnimation = 0;
        this.scrollAnimation = 0;
        this.speed = this.stageIndex + 1;
        if(this.speed > 10) {
            this.speed = 10;
        }

        var specialIndex = this.stageIndex % this.stageSpecials.length;
        this.stageSpecial = this.stageSpecials[specialIndex];
        this.specialAnimation = 0;
    }
    
    this.afterStage = function () {
        this.stageIndex ++;
    }

    this.draw = function () {
        if(this.hud_visible) {
            this.drawHud();
            this.stageSpecial();
            this.specialAnimation++;
            if(this.specialAnimation > 1000000) this.specialAnimation = 0;
        }
             
        setFont1();
        text(this.text, this.text_x, this.text_y);
        
        this.tick();
        
    };
    
    this.noSpecial = function() { }
    
    this.crazySpecial = function() {
        
        this.text_y = height - 60 - Math.abs(Math.sin(this.specialAnimation * 0.2)) * 90;   

        this.speed = Math.cos(this.specialAnimation * 0.1) * 8 + 6;   
    }
    
    this.sinusSpecial = function() {
        this.text_y = height/2 + Math.sin(this.specialAnimation * 0.1) * 40;   
    }
    
    this.cosinusSpecial = function() {
        this.speed = Math.cos(this.specialAnimation * 0.1) * 4 + 2;   
    }


    this.drawHud = function () {
        setFont2();
        
        text("STAGE: " + (this.stageIndex + 1) + "/" + this.stageCount, 10, 24);
        text("SCORE: " + this.score.points.toLocaleString(), 10, height - 10);

        textAlign(RIGHT);
        
        var letterPercent = this.removedLettersInThisStage * 100 / this.totalLettersInThisStage;
        text(letterPercent.toFixed(1) + "%", width - 10, 24);
        
        if(!this.lives) fill('#DD0000');
        text("LIVES: " + this.lives, width - 10, height - 10);
    }
    
    this.tick_scroll = function () {
        this.scrollAnimation++;
        this.drawUnderscore();
        this.text_x -= this.speed;
        while(this.text_x < 0 && this.lives) {
            this.killLetter();
        }
    }
    
    this.tick_waitForFirstKey = function () {
        this.blinkAnimation ++;
        
        var delay = 240;
        
        if(this.blinkAnimation < delay) { 
            return;
        }
        
        this.drawUnderscore();
        
        if(this.blinkAnimation > delay + 20) {
            this.blinkAnimation = delay - 20;
        }
    }
        
    this.tick_die = function () {
        if(this.text.length > 20) {
            var skip = 10;
            this.text = this.text.substr(skip);
            this.removedLettersInThisStage += skip;
        }
        
        this.removeNextChar();
    }
    
    this.drawUnderscore = function () {
        fill(color('#EEFFEE'));
        text("_", this.text_x, this.text_y);
    }
    
    this.getNextCharWidth = function () {
        return textWidth(this.text.substr(0, 1));
    }
    
    this.killLetter = function () {
        if(!--this.lives) {
            this.tick = this.tick_die;
            return;
        }

        this.text_x += this.getNextCharWidth() * 5;
        this.removeNextChar();
    }
    
    this.keyTyped = function() {        
        if (this.isNextChar(key)) {
            this.hud_visible = true;
            this.tick = this.tick_scroll;
            this.delayText();
            this.score.charHit();
            this.removeNextChar();
        } else {
            this.score.charMissed();
        }
        
    }
    
    this.delayText = function () {
        this.text_x += this.getNextCharWidth();
        var max_x = width * 3 / 4;
        if(this.text_x > max_x) { 
            this.text_x = max_x;
        }
    }
    
    this.isNextChar = function(keyString) {
        return this.text[0].toUpperCase() === keyString.toUpperCase();
    }
    
    this.removeNextChar = function() {
        this.removedLettersInThisStage++;
        this.text = this.text.substring(1);
        if(!this.text) {
            this.stageCleared();
        }
    }
    
    this.stageCleared = function() {
        
        this.score.stageCleared();
        
        if (this.textArray.length && this.lives) {
            this.afterStage();
            this.beforeStage();
        } else {
            this.nextScene = new Gameover(this.score);
        }
    }
}

            
            

            
            
            
            
var highscores = new Highscores();
var scene = new Game();

function setup() {
    createCanvas(800, 240);
    
    setupGlobal();
    setupScene();
}

function setupScene() {
    if (scene.setup) {
        scene.setup();
    }    
}

function draw() {
    background(0);
    
    if(scene.draw) {
        var nextScene = scene.draw();
        
        if(scene.nextScene) {
            var nextScene = scene.nextScene;
            scene.nextScene = null;
            scene = nextScene;
            setupScene();
        }
    }
}


function keyPressed() {
    if(scene.keyPressed) {
        scene.keyPressed();
    }
}



function keyTyped() {
    if(scene.keyTyped) {
        scene.keyTyped();
    }
}
        </script>
    </head>
</html>